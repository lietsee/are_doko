# are_doko - 仕事道具保管場所管理アプリ 仕様書

## 1. 概要

### 1.1 アプリの目的
倉庫や作業場に保管している仕事道具の場所と情報を写真ベースで管理するアプリ。
写真上のオブジェクトをクリックすると、道具の名前と保管メモ（重ねて保管する等）がポップアップ表示される。

### 1.2 主要機能
1. **メイン画面**: 倉庫写真の閲覧、オブジェクト情報のポップアップ表示
2. **登録画面**: 写真登録、SAMによるオブジェクト領域自動検出（または手動矩形選択）、情報編集
3. **データ管理**: エクスポート/インポートによるバックアップ

---

## 2. 画面構成

### 2.1 全体レイアウト
```
+------------------+----------------------------------------+
|                  |                                        |
|   サイドバー      |           メインエリア                   |
|   (倉庫リスト)    |         (写真表示/登録)                  |
|                  |                                        |
|  - 倉庫1         |                                        |
|    - 写真1       |                                        |
|    - 写真2       |                                        |
|  - 倉庫2         |                                        |
|    - 写真1       |                                        |
|                  |                                        |
|  [+倉庫追加]      |                                        |
|  [エクスポート]   |                                        |
|  [インポート]     |                                        |
+------------------+----------------------------------------+
```

### 2.2 メイン画面（閲覧モード）

#### 表示内容
- 選択した倉庫写真を中央に表示
- 登録済みオブジェクトの領域を半透明のオーバーレイで常時表示（ホバーで強調）
- 写真切り替え用 < > ボタン（複数写真がある場合）
- サイドバーに写真のサムネイル一覧表示
- ツールバー: [登録モード切替] [倉庫編集] [写真追加]

#### オブジェクトポップアップ
オブジェクト領域をクリック（モバイル: タップ）すると表示：
```
+---------------------------+
|  [クリップ画像サムネイル]   |
|                           |
|  オブジェクト名: ハンマー   |
|                           |
|  メモ:                    |
|  棚の右側に立てて保管      |
|                           |
|  [編集] [削除] [閉じる]    |
+---------------------------+
```

#### モード切替時の動作
- 未保存の変更がある場合は確認ダイアログを表示
- 「変更が保存されていません。破棄しますか？」→ [破棄] [キャンセル]

### 2.3 登録画面（登録モード）

#### レイアウト
```
+------------------+----------------------------------------+
|                  |  +--------------------------------+    |
|   サイドバー      |  |                                |    |
|   (登録中の       |  |      倉庫写真                   |    |
|    オブジェクト   |  |      (クリック可能)             |    |
|    リスト)       |  |                                |    |
|                  |  +--------------------------------+    |
|  - ハンマー       |                                        |
|  - ドリル        |  状態: クリックしてオブジェクトを選択    |
|  - (未登録)      |  入力方式: [SAM検出] [矩形選択]          |
|                  |                                        |
|                  |  [閲覧モードに戻る] [変更を保存]        |
+------------------+----------------------------------------+
```

#### オブジェクト登録フロー（SAM検出）
1. 写真上の道具をクリック
2. SAMがクリック点から領域を自動検出
3. 検出結果をオーバーレイ表示（受け入れ/やり直しボタン）
4. オブジェクト編集フォームが表示
5. 名前とメモを入力して保存

#### オブジェクト登録フロー（矩形選択）
1. 「矩形選択」モードを選択
2. 写真上でドラッグして矩形領域を指定
3. オブジェクト編集フォームが表示
4. 名前とメモを入力して保存

※矩形選択はSAMが利用できない場合のフォールバックとして残す

#### オブジェクト編集フォーム
```
+---------------------------+
|  プレビュー:              |
|  [クリップ画像]           |
|                           |
|  名前: [          ]       |
|  メモ: [                ] |
|        [                ] |
|                           |
|  [保存] [キャンセル]       |
+---------------------------+
```

#### オブジェクトの編集範囲
- **編集可能**: 名前、メモ
- **編集不可**: 領域（変更したい場合は削除して再登録）

### 2.4 倉庫管理

#### 倉庫追加/編集モーダル
```
+---------------------------+
|  倉庫を追加               |
|                           |
|  名前: [          ]       |
|                           |
|  メモ: [                ] |
|        [                ] |
|                           |
|  [保存] [キャンセル]       |
+---------------------------+
```

#### 写真追加
- 倉庫を選択した状態で [写真追加] ボタン
- ドラッグ&ドロップまたはファイル選択
- 写真の名前（例: 「棚上段」「棚下段」）を入力

---

## 3. データ構造

### 3.1 倉庫 (Warehouse)
```typescript
interface Warehouse {
  id: string;              // UUID v4
  name: string;            // 倉庫名（例: "第一倉庫"）
  memo: string;            // 倉庫のメモ
  photos: Photo[];         // 写真リスト
  createdAt: string;       // 作成日時（ISO 8601）
  updatedAt: string;       // 更新日時（ISO 8601）
}
```

### 3.2 写真 (Photo)
```typescript
interface Photo {
  id: string;              // UUID v4
  name: string;            // 写真名（例: "棚上段"）
  imageDataUrl: string;    // Base64エンコードされた写真（data URL形式）
  width: number;           // 画像幅（ピクセル）
  height: number;          // 画像高さ（ピクセル）
  objects: StorageObject[]; // この写真上のオブジェクト（配列順で後ろが優先）
  createdAt: string;       // ISO 8601
  updatedAt: string;       // ISO 8601
}
```

### 3.3 オブジェクト (StorageObject)
```typescript
interface StorageObject {
  id: string;                    // UUID v4
  name: string;                  // オブジェクト名（例: "ハンマー"）
  memo: string;                  // 保管メモ（例: "重ねて保管"）
  clippedImageDataUrl: string;   // クリップされた画像（data URL形式）
  mask: ObjectMask;              // クリック領域
  clickPoint: Position;          // SAMに送ったクリック点（元画像ピクセル座標）
  createdAt: string;             // ISO 8601
  updatedAt: string;             // ISO 8601
}

// クリック領域
type ObjectMask = PolygonMask | RectMask;

interface PolygonMask {
  type: 'polygon';
  points: Position[];  // 多角形の頂点座標（元画像ピクセル座標）
}

interface RectMask {
  type: 'rect';
  x: number;           // 左上X（元画像ピクセル座標）
  y: number;           // 左上Y
  width: number;       // 幅
  height: number;      // 高さ
}

interface Position {
  x: number;
  y: number;
}
```

### 3.4 アプリ全体データ
```typescript
interface AppData {
  version: string;         // データ形式バージョン（セマンティックバージョニング）
  warehouses: Warehouse[];
  createdAt: string | null; // ISO 8601
  updatedAt: string | null; // ISO 8601
}
```

### 3.5 座標系
- 全ての座標は**元画像のピクセル座標**基準（左上原点）
- 表示時のスケーリング変換はフロントエンドで行う

---

## 4. 機能詳細

### 4.1 オブジェクト領域検出（SAM連携）

#### フロー
1. ユーザーが写真上をクリック
2. フロントエンドがクリック座標をSAMバックエンドに送信
3. SAMが領域を推論してポリゴン座標を返す
4. フロントエンドでポリゴンをオーバーレイ表示
5. ユーザーが確認して受け入れ

#### API仕様
```
POST /api/segment

Request:
{
  "image_base64": "...",   // Base64画像データ（data:prefix除く）
  "click_x": 150,          // クリックX座標（元画像ピクセル座標）
  "click_y": 200           // クリックY座標（元画像ピクセル座標）
}

Response (成功時 HTTP 200):
{
  "polygon": [             // ポリゴン頂点リスト
    {"x": 100, "y": 150},
    {"x": 200, "y": 150},
    {"x": 200, "y": 250},
    {"x": 100, "y": 250}
  ],
  "bounding_box": {        // バウンディングボックス
    "x": 100,
    "y": 150,
    "width": 100,
    "height": 100
  },
  "mask_base64": "..."     // マスク画像（オプション）
}

Response (エラー時 HTTP 4xx/5xx):
{
  "error": "エラーメッセージ",
  "code": "ERROR_CODE"
}
```

#### サポート画像形式
- JPEG, PNG
- サイズ制限: なし（ただし処理時間に影響）

#### エラーコード
| コード | 説明 | フロントエンド対応 |
|--------|------|------------------|
| `IMAGE_TOO_LARGE` | 画像サイズが大きすぎる | 「画像が大きすぎます」表示 |
| `INVALID_FORMAT` | サポートされていない画像形式 | 「対応していない画像形式です」表示 |
| `NO_OBJECT_FOUND` | クリック点付近にオブジェクトが見つからない | 「オブジェクトが検出できませんでした。別の場所をクリックしてください」表示 |
| `SERVER_ERROR` | サーバー内部エラー | 「サーバーエラーが発生しました」表示、矩形選択を提案 |

### 4.2 クリップ画像生成
- SAMから返されたバウンディングボックス（または矩形選択領域）を使用
- 元画像から該当領域を切り出し
- Base64としてStorageObjectに保存

### 4.3 オブジェクト領域のクリック判定
- ポリゴン: point-in-polygon判定
- 矩形: 座標範囲判定
- **複数オブジェクトが重なる場合**: 配列の後ろ（後に登録されたもの）を優先

### 4.4 エクスポート/インポート

#### エクスポート
- 全データをJSON形式でダウンロード
- ファイル名: `are_doko_backup_YYYYMMDD_HHMMSS.json`（端末ローカル時刻）
- **注意**: JSONファイルには画像データ（Base64）が含まれるため、ファイルサイズが大きくなる

#### インポート
- JSONファイルを読み込み
- 既存データとの競合時: 確認ダイアログを表示

| モード | 動作 |
|--------|------|
| **上書き** | 既存データを全削除し、インポートデータで置き換え（IDはそのまま使用） |
| **マージ** | インポートデータの全IDを新規生成し、既存データに追加（同名でも別データとして追加） |
| **キャンセル** | インポートを中止 |

### 4.5 削除動作

#### 倉庫削除
1. 確認ダイアログ表示: 「倉庫「XXX」を削除しますか？写真Y件、オブジェクトZ件も削除されます」
2. [削除] → 倉庫・写真・オブジェクトを全て削除
3. [キャンセル] → 何もしない

#### 写真削除
1. 確認ダイアログ表示: 「写真「XXX」を削除しますか？オブジェクトZ件も削除されます」
2. [削除] → 写真・オブジェクトを削除
3. [キャンセル] → 何もしない

#### オブジェクト削除
1. 確認ダイアログ表示: 「オブジェクト「XXX」を削除しますか？」
2. [削除] → オブジェクトを削除
3. [キャンセル] → 何もしない

---

## 5. UI/UX詳細

### 5.1 色・スタイル
- オブジェクト領域: 半透明の青（#3B82F6, opacity 0.3）
- ホバー時（デスクトップ）: opacity 0.5 に変化
- 選択中: 青の実線ボーダー

### 5.2 レスポンシブ対応
- **デスクトップ**: サイドバー常時表示
- **モバイル**: サイドバーはハンバーガーメニューで切り替え

### 5.3 モバイル操作
- **オブジェクト選択**: タップでポップアップ表示（ホバー効果なし）
- **登録時のクリック**: タップで座標送信

### 5.4 ローディング表示
- SAM処理中: スピナー + 「検出中...」メッセージ
- 画像読み込み中: プレースホルダー表示

### 5.5 エラーハンドリング
- SAM接続エラー: 「SAMサーバーに接続できません。矩形選択を使用してください」トースト表示
- 画像読み込みエラー: 「画像を読み込めませんでした」表示

---

## 6. 技術仕様

### 6.1 フロントエンド
- **React 19** + TypeScript
- **Vite 6.x** (ビルドツール)
- **Tailwind CSS 3.x** (スタイリング)
- **Zustand 5.x** (状態管理)
- **idb** (IndexedDB wrapper)

#### React 19採用理由
- 最新のReact機能（Suspense改善、トランジション）
- Zustand 5.x、Tailwind CSS 3.x、Vite 6.xとの互換性確認済み
- n-garden-appプロジェクトで実績あり

### 6.2 SAMバックエンド
- Python + FastAPI
- Segment Anything Model (SAM)
- ローカル起動（開発時: http://localhost:8000）

### 6.3 データ保存

#### IndexedDB
- ローカルブラウザに自動保存
- 容量: ブラウザ依存（通常50MB〜実質無制限）
- **注意**: 大量の高解像度画像を扱う場合はエクスポートでバックアップ推奨

#### 画像保存方式
- **形式**: Base64エンコード（data URL形式）
- **サイズ制限**: なし（元画像サイズのまま保存）

### 6.4 データバージョン管理
- バージョン形式: セマンティックバージョニング（例: `1.0.0`）
- 初期バージョン: `1.0.0`
- マイグレーション: アプリ起動時にバージョンチェック、必要に応じて変換関数を実行

### 6.5 日時形式
- 全てISO 8601形式（例: `2025-01-06T12:34:56.789Z`）

### 6.6 セキュリティ・プライバシー
- **ローカル保存**: 全データはブラウザのIndexedDBに保存（サーバー送信なし）
- **SAM通信**: SAMバックエンドとの通信のみ（ローカルホスト想定）
- **エクスポート注意**:
  - JSONファイルには画像データ（Base64）が含まれる
  - 機密性の高い画像を含む場合は取り扱いに注意
  - ファイルサイズが大きくなる可能性あり

---

## 7. 将来の拡張（今回は対象外）

- [ ] 法線マップ推論（Marigold Normals）
- [ ] オブジェクト検索機能
- [ ] タグ/カテゴリ機能
- [ ] クラウド同期
- [ ] 複数ユーザー対応
- [ ] キーボードアクセシビリティ

---

## 8. 開発フェーズ

### Phase 1: プロジェクト初期化
- Vite + React + TypeScript + Tailwind セットアップ
- 基本的なフォルダ構成

### Phase 2: コアインフラ
- 型定義
- Zustand store
- IndexedDB永続化

### Phase 3: メイン画面
- サイドバー（倉庫/写真リスト）
- 写真表示
- オブジェクトオーバーレイ
- ポップアップ表示

### Phase 4: 登録画面
- 写真アップロード
- クリック処理（まず矩形選択を実装）
- オブジェクト編集フォーム

### Phase 5: SAM統合
- Pythonバックエンド構築
- フロントエンド連携
- 領域検出フロー完成

### Phase 6: 仕上げ
- エクスポート/インポート
- エラーハンドリング
- レスポンシブ対応
- 削除確認ダイアログ

---

## 更新履歴

| バージョン | 日付 | 内容 |
|-----------|------|------|
| 1.0.0 | 2025-01-06 | 初版作成 |
| 1.1.0 | 2025-01-06 | レビュー反映: SAM API詳細化、削除/インポート動作明確化、矩形選択追加、モバイル対応、セキュリティ注意事項追加 |
